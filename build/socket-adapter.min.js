/*!
 * @overview  Ember Data Socket Adapter
 * @copyright Copyright 2014 Collectrium LLC.
 * @author Andrew Fan <andrew.fan@upsilonit.com>
 */
// v0.1.15
// 882931d (2014-06-03 15:03:27 +0300)


!function(a){var b,c,d,e;!function(){var a={},f={};b=function(b,c,d){a[b]={deps:c,callback:d}},e=d=c=function(b){function d(a){if("."!==a.charAt(0))return a;for(var c=a.split("/"),d=b.split("/").slice(0,-1),e=0,f=c.length;f>e;e++){var g=c[e];if(".."===g)d.pop();else{if("."===g)continue;d.push(g)}}return d.join("/")}if(e._eak_seen=a,f[b])return f[b];if(f[b]={},!a[b])throw new Error("Could not find module "+b);for(var g,h=a[b],i=h.deps,j=h.callback,k=[],l=0,m=i.length;m>l;l++)k.push("exports"===i[l]?g={}:c(d(i[l])));var n=j.apply(this,k);return f[b]=g||n,f[b]}}(),b("socket-adapter/adapter",["exports"],function(a){"use strict";var b=Ember.get,c=Ember.set,d=Ember.EnumerableUtils.forEach,e=DS.RESTAdapter.extend({socketAddress:"http://api.collectrium.websocket:5000",bulkOperationsSupport:!0,socketConnections:null,requestsPool:null,generateRequestId:function(){var a=function(){return Math.floor(65536*Math.random()).toString(16)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},getConnection:function(a,e){var f=a.typeKey&&a.store;a=a.typeKey;var g=b(this,"socketConnections"),h=a&&b(g,a),i=this.get("socketAddress")+"/",j=this.get("requestsPool");return 1===arguments.length&&(e={}),a||(e=arguments[0]),h||(a&&(i=i+a+"/"),h=io.connect(i,e),a&&(h.on("message",function(b){if(b.request_id&&j[b.request_id]){var c=j[b.request_id].resolve;delete b.request_id,Ember.run(null,c,b),delete j[b.request_id]}else b.ids?d(b.ids,function(b){var c=f.getById(a,b);f.unloadRecord(c)}):f.pushPayload(a,b.payload)}),c(g,a,h))),h},send:function(a,b,c){var d=this.getConnection(a),e=this.get("requestsPool"),f=this.generateRequestId(),g=Ember.RSVP.defer("DS: SocketAdapter#emit "+b+" to "+a.typeKey);return c instanceof Object||(c={}),c.request_id=f,e[f]=g,d.emit(b,c),g.promise},findAll:function(a,b){return this.send(b,"READ_LIST")},findQuery:function(a,b,c){return this.send(b,"READ_LIST",c)},findMany:function(a,b,c){return this.send(b,"READ_LIST",{ids:c})},find:function(a,b,c){return this.send(b,"READ",{id:c})},createRecord:function(a,b,c){var d=a.serializerFor(b.typeKey),e={};return e[b.typeKey]=[],e[b.typeKey].push(d.serialize(c)),this.send(b,"CREATE",e)},createRecords:function(a,b,c){var e=a.serializerFor(b.typeKey),f={};return f[b.typeKey]=[],d(c,function(a){f[b.typeKey].push(e.serialize(a))}),this.send(b,"CREATE_LIST",f)},updateRecord:function(a,b,c){var d=a.serializerFor(b.typeKey),e={};return e[b.typeKey]=[],e[b.typeKey].push(d.serialize(c,{includeId:!0})),this.send(b,"UPDATE",e)},updateRecords:function(a,b,c){var e=a.serializerFor(b.typeKey),f={};return f[b.typeKey]=[],d(c,function(a){f[b.typeKey].push(e.serialize(a,{includeId:!0}))}),this.send(b,"UPDATE_LIST",f)},deleteRecord:function(a,c,d){var e=b(d,"id");return this.send(c,"DELETE",{id:e})},deleteRecords:function(a,c,e){var f={ids:[]};return d(e,function(a){f.ids.push(b(a,"id"))}),this.send(c,"DELETE_LIST",f)},openSocket:function(){c(this,"socketConnections",Ember.Object.create()),c(this,"requestsPool",Ember.Object.create()),this.getConnection({resource:"handshake"})}.on("init")});a["default"]=e}),b("socket-adapter/belongs_to",["exports"],function(a){"use strict";function b(a,b,f){return Ember.computed("data",function(a,b){var g,h=c(this,"data"),i=c(this,"store"),j="DS: Async belongsTo "+this+" : "+a;if(2===arguments.length)return void 0===b?null:DS.PromiseObject.create({promise:e.cast(b,j)});var k=h.links&&h.links[a],l=h[a];return d(l)?k?(g=i.findBelongsTo(this,k,f),DS.PromiseObject.create({promise:g})):null:(g=i.fetchRecord(l)||e.cast(l,j),DS.PromiseObject.create({promise:g}))}).meta(f)}var c=Ember.get,d=(Ember.set,Ember.isNone),e=Ember.RSVP.Promise;DS.belongsTo=function(a,c){"object"==typeof a&&(c=a,a=void 0),c=c||{};var d={type:a,isRelationship:!0,options:c,kind:"belongsTo"};return b(a,c,d)},a["default"]=DS.belongsTo}),b("socket-adapter/has_many",["exports"],function(a){"use strict";function b(a,b,d,e){var g=this._relationships[e],h="DS: Async hasMany "+this+" : "+e;if(!g){var i=Ember.RSVP.defer(h);g=c(this,e,b,function(a,b){var c,g=b.links&&b.links[e];return c=g?a.findHasMany(this,g,d,i):a.findMany(this,b[e],d.type,i),f(c,"promise",i.promise),c})}var j=g.get("promise").then(function(){return g},null,"DS: Async hasMany records received");return DS.PromiseArray.create({promise:j})}function c(a,b,c,d){var f=a._relationships;if(f[b])return f[b];var h=e(a,"data"),i=e(a,"store"),j=f[b]=d.call(a,i,h);return g(j,{owner:a,name:b,isPolymorphic:c.polymorphic})}function d(a,d){d=d||{};var f={type:a,isRelationship:!0,options:d,kind:"hasMany"};return Ember.computed(function(g){{var h=e(this,"data")[g],i=Ember.A(h).everyProperty("isEmpty",!1);this._relationships[g]}return i?c(this,g,d,function(a,b){b[g];return a.findMany(this,b[g],f.type)}):b.call(this,a,d,f,g)}).property("data").meta(f)}var e=Ember.get,f=Ember.set,g=Ember.setProperties;DS.hasMany=function(a,b){return"object"==typeof a&&(b=a,a=void 0),d(a,b)},a["default"]=DS.hasMany}),b("socket-adapter/json_serializer",["exports"],function(a){"use strict";{var b=Ember.get;Ember.set,Ember.isNone}DS.JSONSerializer.reopen({serializeBelongsTo:function(a,c,d){var e,f=d.key;e=a._data[f]?a._data[f].id:b(a,f),f=this.keyForRelationship?this.keyForRelationship(f,"belongsTo"):f,c[f]=a._data[f]?e:b(e,"id"),d.options.polymorphic&&this.serializePolymorphicType(a,c,d)}}),a["default"]=DS.JSONSerializerer}),b("socket-adapter/main",["socket-adapter/json_serializer","socket-adapter/serializer","socket-adapter/adapter","socket-adapter/store","socket-adapter/has_many","socket-adapter/belongs_to","exports"],function(a,b,c,d,e,f,g){"use strict";var h,i=b["default"],j=c["default"],k=d["default"],l="0.1.15";"undefined"==typeof h&&(h=Ember.Namespace.create({VERSION:l,Adapter:j,Serializer:i,Store:k}),Ember.libraries&&Ember.libraries.registerCoreLibrary("Socket Adapter",h.VERSION)),g["default"]=h}),b("socket-adapter/serializer",["exports"],function(a){"use strict";var b=DS.RESTSerializer.extend({extractFindQuery:function(a,b,c){return this.extractArray(a,b,c.payload)},extractFindAll:function(a,b,c){return this.extractArray(a,b,c.payload)},extractFindMany:function(a,b,c){return this.extractArray(a,b,c.payload)},extractCreateRecords:function(a,b,c){return this.extractArray(a,b,c)},extractUpdateRecords:function(a,b,c){return this.extractArray(a,b,c)},extractDeleteRecords:function(a,b,c){return this.extractArray(a,b,c)}});a["default"]=b}),b("socket-adapter/store",["exports"],function(a){"use strict";function b(a,b,c){return a.lookup("serializer:"+b)||a.lookup("serializer:application")||a.lookup("serializer:"+c)||a.lookup("serializer:-default")}function c(a,c){var d=a.serializer,e=a.defaultSerializer,f=a.container;return f&&void 0===d&&(d=b(f,c.typeKey,e)),(null===d||void 0===d)&&(d={extract:function(a,b,c){return c}}),d}function d(a,b,d,e){var f=e.constructor,g=a[d](b,f,e),i=c(a,f),j="DS: Extract and notify about "+d+" completion of "+e;return g.then(function(a){var c;return c=a?i.extract(b,f,a,h(e,"id"),d):a,b.didSaveRecord(e,c),e},function(a){throw a instanceof DS.InvalidError?b.recordWasInvalid(e,a.errors):b.recordWasError(e,a),a},j)}function e(a,b){return k.create({promise:j.cast(a,b)})}function f(a,b,d,e,f){var g=a[d](b,e,f),h=c(a,e),j="DS: Extract and notify about "+d+" completion of "+f.length+" of type "+e.typeKey;return g.then(function(a){var c;return c=a?h.extract(b,e,a,null,d):a,i(f,function(a,d){b.didSaveRecord(a,c[d])}),f},function(a){throw i(f,function(c){a instanceof DS.InvalidError?b.recordWasInvalid(c,a.errors):b.recordWasError(c,a)}),a},j)}function g(a,b,d,e,f){var g=a.findQuery(b,d,e,f),h=c(a,d),i="DS: Handle Adapter#findQuery of "+d;return j.cast(g,i).then(function(a){var c=h.extract(b,d,a,null,"findQuery");return f.load(c),f},null,"DS: Extract payload of findQuery "+d)}var h=Ember.get,i=(Ember.set,Ember.EnumerableUtils.forEach),j=Ember.RSVP.Promise,k=Ember.ArrayProxy.extend(Ember.PromiseProxyMixin),l=DS.Store.extend({removeIdsFromStore:function(a){var b;if(a instanceof Array)for(b=0;b>a.length;b++);},findQuery:function(a,b){a=this.modelFor(a);var c=this.recordArrayManager.createAdapterPopulatedRecordArray(a,b),d=this.adapterFor(a);return e(g(d,this,a,b,c))},filter:function(a,b,c){var d;3===arguments.length?d=this.findQuery(a,b):2===arguments.length&&(c=b),a=this.modelFor(a);var f=this.recordArrayManager.createFilteredRecordArray(a,c);return d=d||j.cast(f),e(d.then(function(a){var b=a.meta;return b&&f.set("meta",b),f},null,"DS: Store#filter of "+a))},flushPendingSave:function(){var a=this._pendingSave.slice();this._pendingSave=[];var b,c,e,g=[],j=[],k=[],l=[],m=["createRecord","deleteRecord","updateRecord"];if(i(a,function(a){var b,c,e,f=a[0],i=a[1],n=f.constructor,o=this.adapterFor(f.constructor),p=h(o,"bulkOperationsSupport");b=h(f,"isNew")?"createRecord":h(f,"isDeleted")?"deleteRecord":"updateRecord",p?(e=m.indexOf(b),c=j.indexOf(n),-1===c&&(j.push(n),c=j.length-1,g[c]=[],k[c]=[],l[c]=this.adapterFor(f.constructor)),k[c].push(i),g[c][e]instanceof Array||(g[c][e]=[]),g[c][e].push(f)):i.resolve(d(o,this,b,f))},this),g.length)for(c=0;c<g.length;c++)for(e=0;e<m.length;e++)if(g[c][e]&&g[c][e].length){if(1===g[c][e].length)return void k[c][0].resolve(d(l[c],this,m[e],g[c][e][0]));b=k[c],f(l[c],this,m[e].pluralize(),j[c],g[c][e]).then(function(a){i(a,function(a,c){b[c].resolve(a)})})}}});a["default"]=l}),a.SA=c("socket-adapter/main")["default"]}(Ember.lookup);